## Использование OpenIPC как бюджетного видеолинка для FPV систем

Классический сетап в проекте [OpenHD](https://openhdfpv.org/) (и других похожих проектов) состоит из MIPI- или USB- камеры, подключенной к Raspberry Pi и Jetson Nano, которые выступают видеоэнкодером и роутером воздушной системы и в свою очередь соединены с WiFi адаптером по USB и с полетным контроллером по UART. Наземная станция обычно состоит и такого же WiFi адаптера, роутера и высококонтрастного монитора.

Иногда MIPI- или USB- камера меняется на IP-камеру, которая и мощнее (имеет свой собственный аппаратный энкодер) и стоит дешевле при аналогичных характеристиках. Большинство современных видеокамер являются типовыми embedded устройствами с Linux на борту (но значительно скромнее в размерах RAM и флеш памяти по сравнению с Raspberry и Jetson), что позволяет компилировать и запускать на них практически любое переносимое ПО.

В процессе работы с данной технологией возникла идея об упрощении полетной системы и переноса всего необходимого ПО непосредственно на IP-камеру.

### Преимущества

* Снижается стоимость системы (IP камера с поддержкой H.265 против аналога на Jetson Nano с MIPI камерой)
* Снижается общее потребление и увеличивается надежность системы за счет упрощения схемы
* Снижается задержка передачи видео: на наших Glass-to-Glass тестах мы получали для 1080p@60 задержку около 80ms (на среднебюджетных камерах), и для 720p@30 около 130 ms и 1080p@30 около 150 ms (для самых бюджетных камер)
* Появляется возможность тюнинга аппаратного энкодера (специфика сильно зависит от вендора IP камеры)
* Сообществом накоплен огромный опыт [ремонта IP камер](https://t.me/ExIPCam), что позволяет еще более удешевить стоимость эксплуатации системы

### Недостатки

* Из-за ограниченных ресурсов (установленной оперативной и постоянной памяти) большинство модных языков программирования (таких как Java, Python, NodeJS) камера не потянет. Если любите писать на этих языках (или хотите портировать ПО, написанное на этих языках на камеру), то придется искать решения.
Замена флеш памяти на более емкую принесет радость в дом  Golang и Rust разработчиков.
* Придется немного паять, чтобы доработать до ума сверхбюджетные платы, но уверен, что в мире FPV этого никого не испугать
* В большинстве систем версия ядра Linux ограничена вендором IP камеры из-за того, что часть модулей поставляются в бинарном виде. Доработка драйверов ядра новых WiFi адаптеров или специфической периферии может потребовать значительного времени.

### Ингредиенты

* IP-камера. Учитывая популярность среди FPV сообщества модели [VEYE 307](http://www.veye.cc/en/product/cs-mipi-imx307/), мы рекомендуем приобрести плату IVG-G2S IP камеры производства компании XiongMai с точно таким же сенсором IMX307, но [по более приятной цене](https://aliexpress.com/item/1005003386137528.html) (или еще [более приятной](https://item.taobao.com/item.htm?id=660122799616), если есть возможность покупки на Taobao, например, [через посредника](https://www.youcanbuy.ru/)). При заказе платы укажите, фокусное расстояние объектива, который установит продавец под ваш заказ (больше фокусное расстояние - больше увеличение, но меньше угол обзора).
В дальнейшем объектив можно поменять на другой с такой же резьбой, либо сразу купить несколько моделей на выбор (стандартом в мире видеонаблюдения считается 3.6мм).
Плата IP-камеры питается от 12V (фактически достаточно 5V, если не использовать ее как видеокамеру вместе с подсветкой) и для начальных тестов желательно взять сразу совмещенный кабель питание-Ethernet, который бывает двух типов: 12V с подключением питания через джек и активный PoE 48V (выбирайте в зависимости от возможностей вашего сетевого коммутатора).

* Программатор SPI NOR для флеш памяти. В принципе можно обойтись без него средствами проекта [burn](https://github.com/OpenIPC/burn), который позволяет заливать систему в пустой/убитый флеш.

### Установка

* Подключите кабель к камере и проверьте, что она работает (IP адрес по-умолчанию 192.168.1.10, ссылка для VLC `"rtsp://192.168.1.10/user=admin&password=&channel=0&stream=0"`). Припаяйте трехпроводной разъем UART к свободным площадкам на плате камеры, подключите UART-USB адаптер к компьютеру и проверьте, что при включении камеры идет вывод данных и вы можете прервать загрузку через `Ctrl-C` (работают обе RX и TX линии).
* Выключите камеру, отпаяйте оригинальную 8 мегабайтную SPI NOR флеш микросхему и сделайте на всякий случай ее дамп с помощью программатора.
* Залейте [U-Boot](https://github.com/OpenIPC/firmware/releases/download/latest/u-boot-gk7205v200-universal.bin) в новую 16 мегабайтную флеш (в начало памяти) и припаяйте его на плату. Проверьте, что U-Boot запускается и вы попадаете в строку приглашения.
